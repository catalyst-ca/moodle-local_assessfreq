{"version":3,"sources":["../src/dashboard_assessment.js"],"names":["define","$","Ajax","Fragment","Templates","Notification","Calendar","Str","ZoomModal","Dayview","UserPreference","ChartData","DashboardAssessment","contextid","yearselect","yearselectheatmap","metricselectheatmap","timeout","modulesJson","heatmapOptionsJson","cards","cardId","call","yearButtonAction","event","preventDefault","element","target","tagName","toLowerCase","dataset","year","activeoptions","document","getElementById","getElementsByClassName","i","length","classList","remove","add","setUserPreference","yeartitle","innerHTML","getCardCharts","updateHeatmapDebounce","clearTimeout","setTimeout","updateHeatmap","detailView","display","date","generateHeatmap","heatmapOptions","JSON","parse","parseInt","metric","modules","heatmapContainer","spinner","generate","then","calendar","calendarContainer","addEventListener","tooltip","createHeatScale","heatScale","heatScaleContainer","outerHTML","catch","exception","Error","updateDownload","downloadForm","formElements","elements","toRemove","type","name","value","startsWith","push","input","createElement","appendChild","cardsModulesSelectHeatmapElement","links","getElementsByTagName","contains","module","stringify","optionsObj","optionsJson","yearHeatmapButtonAction","metricHeatmapButtonAction","moduleListChildrenEvents","all","j","stopPropagation","dropdownmenu","toggle","triggerZoomGraph","closest","params","zoomGraph","init","context","cardsYearSelectElement","cardsYearSelectHeatmapElement","cardsMetricSelectHeatmapElement","dueMonthZoom","dueActivityZoom","dueStudentZoom"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript for report card display and processing.\n *\n * @package    local_assessfreq\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/fragment', 'core/templates', 'core/notification', 'local_assessfreq/calendar', 'core/str',\n    'local_assessfreq/zoom_modal', 'local_assessfreq/dayview', 'local_assessfreq/user_preferences', 'local_assessfreq/chart_data'],\nfunction($, Ajax, Fragment, Templates, Notification, Calendar, Str, ZoomModal, Dayview, UserPreference, ChartData) {\n\n    /**\n     * Module level variables.\n     */\n    var DashboardAssessment = {};\n    var contextid;\n    var yearselect;\n    var yearselectheatmap;\n    var metricselectheatmap;\n    var timeout;\n    var modulesJson = '';\n    var heatmapOptionsJson = '';\n\n    const cards = [\n        {cardId: 'local-assessfreq-assess-due-month', call: 'assess_by_month'},\n        {cardId: 'local-assessfreq-assess-by-activity', call: 'assess_by_activity'},\n        {cardId: 'local-assessfreq-assess-due-month-student', call: 'assess_by_month_student'}\n    ];\n\n    /**\n     * Get and process the selected year from the dropdown,\n     * and update the corresponding user perference.\n     *\n     * @param {event} event The triggered event for the element.\n     */\n    const yearButtonAction = function(event) {\n        event.preventDefault();\n        var element = event.target;\n\n        if (element.tagName.toLowerCase() === 'a' && element.dataset.year !== yearselect) { // Only act on certain elements.\n            yearselect = element.dataset.year;\n            let activeoptions = document.getElementById('local-assessfreq-cards-year-filter').getElementsByClassName('active');\n\n            // Fix active classes.\n            for (var i = 0; i < activeoptions.length; i++) {\n                activeoptions[i].classList.remove('active');\n            }\n            element.classList.add('active');\n\n            // Save selection as a user preference.\n            UserPreference.setUserPreference('local_assessfreq_overview_year_preference', yearselect);\n\n            // Update card data based on selected year.\n            var yeartitle = document.getElementById('local-assessfreq-report-overview')\n                .getElementsByClassName('local-assessfreq-year')[0];\n            yeartitle.innerHTML = yearselect;\n\n            ChartData.getCardCharts(0, null, yearselect); // Process loading for the assessment cards.\n        }\n    };\n\n    /**\n     * Quick and dirty debounce method for the heatmap settings menu.\n     * This stops the ajax method that updates the heatmap from being updated\n     * while the user is still checking options.\n     *\n     */\n    const updateHeatmapDebounce = function() {\n        clearTimeout(timeout);\n        timeout = setTimeout(updateHeatmap(), 750);\n    };\n\n    /**\n     * Display heatmap calendar.\n     *\n     * @param {event} event The triggered event for the element.\n     */\n    const detailView = function(event) {\n        let element = event.target;\n        if (element.tagName.toLowerCase() === 'td' && element.dataset.event === 'true') { // Only act on certain elements.\n            Dayview.display(element.dataset.date);\n        }\n    };\n\n    /**\n     * Start heatmap generation.\n     *\n     */\n    const generateHeatmap = function() {\n        let heatmapOptions = JSON.parse(heatmapOptionsJson);\n        let year = parseInt(heatmapOptions.year);\n        let metric = heatmapOptions.metric;\n        let modules = heatmapOptions.modules;\n        let heatmapContainer = document.getElementById('local-assessfreq-report-heatmap');\n        let spinner = heatmapContainer.getElementsByClassName('overlay-icon-container')[0];\n\n        spinner.classList.remove('hide'); // Show spinner if not already shown.\n\n        Calendar.generate(year, 0, 11, metric, modules)\n        .then(calendar => {\n            let calendarContainer = document.getElementById('local-assessfreq-report-heatmap-months');\n            calendarContainer.innerHTML = calendar.innerHTML;\n            calendarContainer.addEventListener('click', detailView);\n            $('[data-toggle=\"tooltip\"]').tooltip();\n        })\n        .then(Calendar.createHeatScale)\n        .then((heatScale) => {\n            let heatScaleContainer = document.getElementById('local-assessfreq-report-heatmap-scale');\n            heatScaleContainer.innerHTML = heatScale.outerHTML;\n            spinner.classList.add('hide'); // Hide sinner if not already hidden.\n        })\n        .catch(() => {\n            Notification.exception(new Error('Failed to calendar.'));\n            return;\n        });\n    };\n\n    const updateDownload = ({year, metric, modules}) => {\n        let downloadForm = document.getElementById('local-assessfreq-heatmap-form');\n        let formElements = downloadForm.elements;\n        let toRemove = new Array();\n\n        if (modules.length === 0) {\n            modules = ['all'];\n        }\n\n        for (let i = 0; i < formElements.length; i++) {\n            if (formElements[i] === undefined) {\n                continue;\n            }\n            // Update year field.\n            if ((formElements[i].type === 'hidden') && (formElements[i].name === 'year')) {\n                formElements[i].value = year;\n                continue;\n            }\n\n            // Update metric field.\n            if ((formElements[i].type === 'hidden') && (formElements[i].name === 'metric')) {\n                formElements[i].value = metric;\n                continue;\n            }\n\n            // Update module fields.\n            if ((formElements[i].type === 'hidden') && (formElements[i].name.startsWith('modules'))) {\n                toRemove.push(formElements[i]);\n                continue;\n            }\n        }\n\n        for (const element of toRemove) {\n            element.remove();\n        }\n\n        for (let i = 0; i < modules.length; i++) {\n            let input = document.createElement('input');\n            input.type = 'hidden';\n            input.name = 'modules[' + modules[i] + ']';\n            input.value = modules[i];\n\n            downloadForm.appendChild(input);\n        }\n    };\n\n    /**\n     * Update the heatmap based on the current filter settings.\n     *\n     */\n    const updateHeatmap = function() {\n        // Get current state of select menu items.\n        var cardsModulesSelectHeatmapElement = document.getElementById('local-assessfreq-heatmap-modules');\n        var links = cardsModulesSelectHeatmapElement.getElementsByTagName('a');\n        var modules = [];\n\n        for (var i = 0; i < links.length; i++) {\n            if (links[i].classList.contains('active')) {\n                let module = links[i].dataset.module;\n                modules.push(module);\n            }\n        }\n\n        // Save selection as a user preference.\n        if (modulesJson !== JSON.stringify(modules)) {\n            modulesJson = JSON.stringify(modules);\n            UserPreference.setUserPreference('local_assessfreq_heatmap_modules_preference', modulesJson);\n        }\n\n        // Build settings object.\n        var optionsObj = {\n            'year': yearselectheatmap,\n            'metric': metricselectheatmap,\n            'modules': modules\n        };\n\n        var optionsJson = JSON.stringify(optionsObj);\n\n        if (optionsJson !== heatmapOptionsJson) { // Compare to global to see if there are any changes.\n            // If list has changed fetch heatmap and update user preference.\n            heatmapOptionsJson = optionsJson;\n            generateHeatmap();\n\n            // Update the download options.\n            updateDownload(optionsObj);\n        }\n    };\n\n    /**\n     * Get and process the selected year from the dropdown for the heatmap display,\n     * and update the corresponding user preference.\n     *\n     * @param {event} event The triggered event for the element.\n     */\n    const yearHeatmapButtonAction = function(event) {\n        event.preventDefault();\n        var element = event.target;\n\n        if (element.tagName.toLowerCase() === 'a' && element.dataset.year !== yearselectheatmap) { // Only act on certain elements.\n            yearselectheatmap = element.dataset.year;\n            let activeoptions = document.getElementById('local-assessfreq-cards-year-heat-filter').getElementsByClassName('active');\n\n            // Fix active classes.\n            for (var i = 0; i < activeoptions.length; i++) {\n                activeoptions[i].classList.remove('active');\n            }\n            element.classList.add('active');\n\n            // Save selection as a user preference.\n            UserPreference.setUserPreference('local_assessfreq_heatmap_year_preference', yearselectheatmap);\n\n            // Update card data based on selected year.\n            var yeartitle = document.getElementById('local-assessfreq-report-heatmap')\n                .getElementsByClassName('local-assessfreq-year')[0];\n            yeartitle.innerHTML = yearselectheatmap;\n\n            updateHeatmapDebounce(); // Call function to update heatmap.\n        }\n    };\n\n    /**\n     * Get and process the selected assessment metric from the dropdown for the heatmap display,\n     * and update the corresponding user preference.\n     *\n     * @param {event} event The triggered event for the element.\n     */\n    const metricHeatmapButtonAction = function(event) {\n        event.preventDefault();\n        var element = event.target;\n        let activeoptions = document.getElementById('local-assessfreq-heatmap-metrics-filter').getElementsByClassName('active');\n\n        if (element.tagName.toLowerCase() === 'a' && element.dataset.metric !== metricselectheatmap) {\n            metricselectheatmap = element.dataset.metric;\n\n            // Fix active classes.\n            for (var i = 0; i < activeoptions.length; i++) {\n                activeoptions[i].classList.remove('active');\n            }\n            element.classList.add('active');\n\n            // Save selection as a user preference.\n            UserPreference.setUserPreference('local_assessfreq_heatmap_metric_preference', metricselectheatmap);\n\n            updateHeatmapDebounce(); // Call function to update heatmap.\n        }\n    };\n\n    /**\n     * Add the event listeners to the modules in the module select dropdown.\n     *\n     * @param {Object} element The dropdown HTML element that contains the list of modules as links.\n     */\n    const moduleListChildrenEvents = function(element) {\n        var links = element.getElementsByTagName('a');\n        var all = links[0];\n\n        for (var i = 0; i < links.length; i++) {\n            let module = links[i].dataset.module;\n\n            if (module.toLowerCase() === 'all') {\n                links[i].addEventListener('click', function(event){\n                    event.preventDefault();\n                    // Remove active class from all other links.\n                    for (var j = 0; j < links.length; j++) {\n                        links[j].classList.remove('active');\n                    }\n                    updateHeatmapDebounce(); // Call function to update heatmap.\n                });\n            } else if (module.toLowerCase() === 'close') {\n                links[i].addEventListener('click', function(event){\n                    event.preventDefault();\n                    event.stopPropagation();\n\n                    var dropdownmenu = document.getElementById('local-assessfreq-heatmap-modules-filter');\n                    dropdownmenu.classList.remove('show');\n\n                    updateHeatmapDebounce(); // Call function to update heatmap.\n                });\n\n            } else {\n                links[i].addEventListener('click', function(event){\n                    event.preventDefault();\n                    event.stopPropagation();\n\n                    all.classList.remove('active');\n\n                    event.target.classList.toggle('active');\n                    updateHeatmapDebounce();\n                });\n            }\n\n        }\n    };\n\n    /**\n     * Thin wrapper to add extra data to click event.\n     */\n    const triggerZoomGraph = function(event) {\n        let call = event.target.closest('div').dataset.call;\n        let params = {'data': JSON.stringify({'year': yearselect, 'call': call})};\n        let method = 'get_chart';\n\n        ZoomModal.zoomGraph(event, params, method);\n    };\n\n    /**\n     * Initialise method for report card rendering.\n     *\n     * @param {integer} context The current context id.\n     */\n    DashboardAssessment.init = function(context) {\n        contextid = context;\n\n        // Set up event listener and related actions for year dropdown on report cards.\n        let cardsYearSelectElement = document.getElementById('local-assessfreq-cards-year');\n        yearselect = cardsYearSelectElement.getElementsByClassName('active')[0].dataset.year;\n        cardsYearSelectElement.addEventListener('click', yearButtonAction);\n\n        // Set up event listener and related actions for year dropdown on heatmp.\n        let cardsYearSelectHeatmapElement = document.getElementById('local-assessfreq-heatmap-year');\n        yearselectheatmap = cardsYearSelectHeatmapElement.getElementsByClassName('active')[0].dataset.year;\n        cardsYearSelectHeatmapElement.addEventListener('click', yearHeatmapButtonAction);\n\n        // Set up event listener and related actions for metric dropdown on heatmp.\n        let cardsMetricSelectHeatmapElement = document.getElementById('local-assessfreq-heatmap-metrics');\n        metricselectheatmap = cardsMetricSelectHeatmapElement.getElementsByClassName('active')[0].dataset.metric;\n        cardsMetricSelectHeatmapElement.addEventListener('click', metricHeatmapButtonAction);\n\n        // Set up event listener and related actions for module dropdown on heatmp.\n        let cardsModulesSelectHeatmapElement = document.getElementById('local-assessfreq-heatmap-modules');\n        moduleListChildrenEvents(cardsModulesSelectHeatmapElement);\n\n        // Set up zoom event listeners.\n        let dueMonthZoom = document.getElementById('local-assessfreq-assess-due-month-zoom');\n        dueMonthZoom.addEventListener('click', triggerZoomGraph);\n\n        let dueActivityZoom = document.getElementById('local-assessfreq-assess-by-activity-zoom');\n        dueActivityZoom.addEventListener('click', triggerZoomGraph);\n\n        let dueStudentZoom = document.getElementById('local-assessfreq-assess-due-month-student-zoom');\n        dueStudentZoom.addEventListener('click', triggerZoomGraph);\n\n        // Create the zoom modal.\n        ZoomModal.init(context);\n\n        // Setup the dayview modal.\n        Dayview.init();\n\n        // Setup the chart data for each card.\n        ChartData.init(cards, contextid, 'get_chart', 'core/chart');\n\n        // Process loading for the assessment cards.\n        ChartData.getCardCharts(0, null, yearselect);\n\n        // Get the data for the heatmap.\n        updateHeatmap();\n\n    };\n\n    return DashboardAssessment;\n});\n"],"file":"dashboard_assessment.min.js"}