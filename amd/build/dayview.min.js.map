{"version":3,"sources":["../src/dayview.js"],"names":["define","Str","Notification","ModalFactory","ModalLarge","Templates","Ajax","Dayview","modalObj","stringArr","key","component","stringResult","getUserDate","timestamp","format","Promise","resolve","date","Date","year","getFullYear","month","getMonth","day","getDate","hours","getHours","minutes","getMinutes","strftimetime","substr","formatData","response","responseArr","JSON","parse","scaler","i","length","endyear","endmonth","endday","dayStart","getTime","secondsSinceDayStart","timestart","leftMargin","width","timeend","start","leftmargin","end","display","jsonArgs","stringify","modules","call","methodname","args","jsondata","then","setBody","render","rows","show","fail","exception","Error","init","get_strings","catch","stringReturn","get_string","title","create","type","TYPE","body","done","modal"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript for heatmap calendar generation and display.\n *\n * @package    local_assessfreq\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'core/notification', 'core/modal_factory', 'local_assessfreq/modal_large', 'core/templates', 'core/ajax'],\nfunction(Str, Notification, ModalFactory, ModalLarge, Templates, Ajax) {\n\n    /**\n     * Module level variables.\n     */\n    var Dayview = {};\n    var modalObj;\n    const spinner = '<p class=\"text-center\">'\n        + '<i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i>'\n        + '</p>';\n\n    const stringArr = [\n        {key: 'sun', component: 'calendar'},\n        {key: 'mon', component: 'calendar'},\n        {key: 'tue', component: 'calendar'},\n        {key: 'wed', component: 'calendar'},\n        {key: 'thu', component: 'calendar'},\n        {key: 'fri', component: 'calendar'},\n        {key: 'sat', component: 'calendar'},\n        {key: 'jan', component: 'local_assessfreq'},\n        {key: 'feb', component: 'local_assessfreq'},\n        {key: 'mar', component: 'local_assessfreq'},\n        {key: 'apr', component: 'local_assessfreq'},\n        {key: 'may', component: 'local_assessfreq'},\n        {key: 'jun', component: 'local_assessfreq'},\n        {key: 'jul', component: 'local_assessfreq'},\n        {key: 'aug', component: 'local_assessfreq'},\n        {key: 'sep', component: 'local_assessfreq'},\n        {key: 'oct', component: 'local_assessfreq'},\n        {key: 'nov', component: 'local_assessfreq'},\n        {key: 'dec', component: 'local_assessfreq'},\n    ];\n    var stringResult;\n\n    const getUserDate = function (timestamp, format) {\n        return new Promise((resolve) => {\n            let date = new Date(timestamp * 1000);\n            const year = date.getFullYear();\n            const month = stringResult[(7 + date.getMonth())];\n            const day = date.getDate();\n            const hours = date.getHours();\n            const minutes = '0' + date.getMinutes();\n\n            const strftimetime = hours + ':' + minutes.substr(-2); // Will display time in 10:30 format.\n            const strftimedatetime = day + ' ' + month + ' ' + year + ', ' + strftimetime;\n\n            if (format === 'strftimetime') {\n                resolve(strftimetime);\n            } else {\n                resolve(strftimedatetime);\n            }\n\n        });\n    };\n\n    const formatData = async function(response) {\n        let responseArr = JSON.parse(response);\n\n        // We are displaying the event as a bar whose width represents the start and end time of the event.\n        // We need to scale the width of the bar to match the width of the container. Therefore 100% width of the container\n        // equals 24 hours (one day).\n        // There are 1440 mins per day. 1440 mins equals 100%, therefore 1 min = (100/1440)%. 5/72 == 100/1440.\n        let scaler = 5/72;\n\n        for (let i=0; i<responseArr.length; i++) {\n            const year = responseArr[i].endyear;\n            const month = (responseArr[i].endmonth) - 1; // Minus 1 for difference between months in PHP and JS.\n            const day = responseArr[i].endday;\n            const dayStart = (new Date(year, month, day).getTime()) / 1000;\n            let secondsSinceDayStart = responseArr[i].timestart - dayStart;\n            let leftMargin = 0;\n            let width = 0;\n\n            if (secondsSinceDayStart <= 0) {\n                secondsSinceDayStart = 0;\n                width = ((responseArr[i].timeend - dayStart) / 60) * scaler;\n                responseArr[i].start = await getUserDate(responseArr[i].timestart, 'strftimedatetime');\n            } else {\n                leftMargin = (secondsSinceDayStart / 60) * scaler;\n                width = ((responseArr[i].timeend - responseArr[i].timestart) / 60) * scaler;\n                responseArr[i].start = await getUserDate(responseArr[i].timestart, 'strftimetime');\n            }\n\n            if (leftMargin + width > 100) {\n                width = 100 - leftMargin;\n            }\n\n            responseArr[i].leftmargin = leftMargin;\n            responseArr[i].width = width;\n            responseArr[i].end = await getUserDate(responseArr[i].timeend, 'strftimetime');\n        }\n\n        return new Promise((resolve) => {\n            resolve(responseArr);\n        });\n    };\n\n\n    /**\n     * Initialise the base modal to be used.\n     *\n     */\n    Dayview.display = function(date) {\n        let context = {};\n        let args = {\n                date: date,\n                modules: ['all']\n            };\n            let jsonArgs = JSON.stringify(args);\n        Ajax.call([{\n            methodname: 'local_assessfreq_get_day_events',\n            args: {jsondata: jsonArgs},\n        }])[0]\n        .then(formatData)\n        .then((responseArr) => {\n\n            let context = {rows: responseArr};\n            modalObj.setBody(Templates.render('local_assessfreq/dayview', context));\n            modalObj.show();\n\n        }).fail(() => {\n            Notification.exception(new Error('Failed to load day view'));\n        });\n\n        //modalObj.setTitle(title);\n        modalObj.setBody(Templates.render('local_assessfreq/dayview', context));\n        modalObj.show();\n\n\n    };\n\n    /**\n     * Initialise the base modal to be used.\n     *\n     * @param {integer} context The current context id.\n     */\n    Dayview.init = function() {\n        // Load the strings we'll need later.\n        Str.get_strings(stringArr).catch(() => { // Get required strings.\n            Notification.exception(new Error('Failed to load strings'));\n            return;\n        }).then(stringReturn => { // Save string to global to be used later.\n            stringResult = stringReturn;\n        });\n\n        Str.get_string('schedule', 'local_assessfreq').then((title) => {\n            // Create the Modal.\n            ModalFactory.create({\n                type: ModalLarge.TYPE,\n                title: title,\n                body: spinner\n            })\n            .done((modal) => {\n                modalObj = modal;\n\n            });\n        }).catch(() => {\n            Notification.exception(new Error('Failed to load string: loading'));\n        });\n\n    };\n\n    return Dayview;\n});\n"],"file":"dayview.min.js"}