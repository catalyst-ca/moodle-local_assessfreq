{"version":3,"sources":["../src/student_search.js"],"names":["define","Ajax","Fragment","Notification","OverrideModal","TableHandler","UserPreference","StudentSearch","contextid","hoursAhead","hoursBehind","refreshPeriod","counterid","refreshCounter","reset","progressElement","document","getElementById","clearInterval","setAttribute","setInterval","progressWidthAria","getAttribute","progressStep","getTable","tableSearchAheadSet","event","preventDefault","target","tagName","toLowerCase","hours","dataset","metric","setUserPreference","then","fail","exception","Error","tableSearchBehindSet","refreshAction","element","closest","id","period","init","context","tableSearchInputElement","tableSearchResetElement","tableSearchRowsElement","tableSearchAheadElement","tableSearchBehindElement","refreshElement","addEventListener","tableSearch","tableSearchReset","tableSearchRowSet","getUserPreference","response","preferences","value"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript for student search display and processing.\n *\n * @package    local_assessfreq\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'core/ajax',\n    'core/fragment',\n    'core/notification',\n    'local_assessfreq/override_modal',\n    'local_assessfreq/table_handler',\n    'local_assessfreq/user_preferences',\n    ], function(Ajax, Fragment, Notification, OverrideModal, TableHandler, UserPreference) {\n\n    /**\n     * Module level variables.\n     */\n    var StudentSearch = {};\n    var contextid;\n    var hoursAhead = 4;\n    var hoursBehind = 1;\n    var refreshPeriod = 60;\n    var counterid;\n\n    /**\n     * Function for refreshing the counter.\n     *\n     * @param {boolean} reset the current count process.\n     */\n    const refreshCounter = function(reset = true) {\n        let progressElement = document.getElementById('local-assessfreq-period-progress');\n\n        // Reset the current count process.\n        if (reset === true) {\n            clearInterval(counterid);\n            counterid = null;\n            progressElement.setAttribute('style', 'width: 100%');\n            progressElement.setAttribute('aria-valuenow', 100);\n        }\n\n        // Exit early if there is already a counter running.\n        if (counterid) {\n            return;\n        }\n\n        counterid = setInterval(() => {\n            let progressWidthAria = progressElement.getAttribute('aria-valuenow');\n            const progressStep = 100 / refreshPeriod;\n\n            if ((progressWidthAria - progressStep) > 0) {\n                progressElement.setAttribute('style', 'width: ' + (progressWidthAria - progressStep) + '%');\n                progressElement.setAttribute('aria-valuenow', (progressWidthAria - progressStep));\n            } else {\n                clearInterval(counterid);\n                counterid = null;\n                progressElement.setAttribute('style', 'width: 100%');\n                progressElement.setAttribute('aria-valuenow', 100);\n                TableHandler.getTable(0, [hoursAhead, hoursBehind], null);\n                refreshCounter();\n            }\n        }, (1000));\n    };\n\n    /**\n     * Process the hours ahead event from the student table.\n     *\n     * @param {Event} event The triggered event for the element.\n     */\n    const tableSearchAheadSet = function(event) {\n        event.preventDefault();\n        if (event.target.tagName.toLowerCase() === 'a') {\n            let hours = event.target.dataset.metric;\n            UserPreference.setUserPreference('local_assessfreq_student_search_table_hoursahead_preference', hours)\n            .then(() => {\n                hoursAhead = hours;\n                TableHandler.getTable(0, [hoursAhead, hoursBehind], null); // Reload the table. // Reload the table.\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to update user preference: hours ahead'));\n            });\n        }\n    };\n\n    /**\n     * Process the hours behind event from the student table.\n     *\n     * @param {Event} event The triggered event for the element.\n     */\n    const tableSearchBehindSet = function(event) {\n        event.preventDefault();\n        if (event.target.tagName.toLowerCase() === 'a') {\n            let hours = event.target.dataset.metric;\n            UserPreference.setUserPreference('local_assessfreq_student_search_table_hoursbehind_preference', hours)\n            .then(() => {\n                hoursBehind = hours;\n                TableHandler.getTable(0, [hoursAhead, hoursBehind], null); // Reload the table. // Reload the table.\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to update user preference: hours behind'));\n            });\n        }\n    };\n\n    /**\n     * Handle processing of refresh and period button actions.\n     *\n     * @param {Event} event The triggered event for the element.\n     */\n    const refreshAction = function(event) {\n        event.preventDefault();\n        var element = event.target;\n\n        if (element.closest('button') !== null && element.closest('button').id === 'local-assessfreq-refresh-quiz-dashboard') {\n            refreshCounter(true);\n            TableHandler.getTable(0, [hoursAhead, hoursBehind], null);\n        } else if (element.tagName.toLowerCase() === 'a') {\n            refreshPeriod = element.dataset.period;\n            refreshCounter(true);\n            UserPreference.setUserPreference('local_assessfreq_quiz_refresh_preference', refreshPeriod);\n        }\n    };\n\n    /**\n     * Initialise method for student search.\n     *\n     * @param {integer} context The current context id.\n     */\n    StudentSearch.init = function(context) {\n        contextid = context;\n        TableHandler.init(\n            0,\n            contextid,\n            'local-assessfreq-student-search-table',\n            'local-assessfreq-student-search',\n            'get_student_search_table',\n            'local_assessfreq_student_search_table_rows_preference',\n            'local-assessfreq-quiz-student-table-search',\n            'local_assessfreq_student_search_table',\n            'local_assessfreq_set_table_preference'\n        );\n\n        // Add required initial event listeners.\n        let tableSearchInputElement = document.getElementById('local-assessfreq-quiz-student-table-search');\n        let tableSearchResetElement = document.getElementById('local-assessfreq-quiz-student-table-search-reset');\n        let tableSearchRowsElement = document.getElementById('local-assessfreq-quiz-student-table-rows');\n        let tableSearchAheadElement = document.getElementById('local-assessfreq-quiz-student-table-hoursahead');\n        let tableSearchBehindElement = document.getElementById('local-assessfreq-quiz-student-table-hoursbehind');\n        let refreshElement = document.getElementById('local-assessfreq-period-container');\n\n        tableSearchInputElement.addEventListener('keyup', TableHandler.tableSearch);\n        tableSearchInputElement.addEventListener('paste', TableHandler.tableSearch);\n        tableSearchResetElement.addEventListener('click', TableHandler.tableSearchReset);\n        tableSearchRowsElement.addEventListener('click', TableHandler.tableSearchRowSet);\n        tableSearchAheadElement.addEventListener('click', tableSearchAheadSet);\n        tableSearchBehindElement.addEventListener('click', tableSearchBehindSet);\n        refreshElement.addEventListener('click', refreshAction);\n\n        UserPreference.getUserPreference('local_assessfreq_student_search_table_hoursahead_preference')\n            .then((response) => {\n                hoursAhead = response.preferences[0].value ? response.preferences[0].value : 4;\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to get use preference: hoursahead'));\n            });\n\n        UserPreference.getUserPreference('local_assessfreq_student_search_table_hoursbehind_preference')\n            .then((response) => {\n                hoursBehind = response.preferences[0].value ? response.preferences[0].value : 1;\n                // Render the student search table.\n                TableHandler.getTable(0, [hoursAhead, hoursBehind], null);\n                OverrideModal.init(context, TableHandler.getTable, [hoursAhead, hoursBehind]);\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to get use preference: hoursbehind'));\n            });\n    };\n\n    return StudentSearch;\n});\n"],"file":"student_search.min.js"}