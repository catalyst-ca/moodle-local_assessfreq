{"version":3,"sources":["../src/student_search.js"],"names":["define","$","Notification","OverrideModal","TableHandler","UserPreference","StudentSearch","contextid","hoursAhead","hoursBehind","refreshPeriod","counterid","refreshCounter","reset","progressElement","document","getElementById","clearInterval","setAttribute","setInterval","progressWidthAria","getAttribute","progressStep","getTable","tableSearchAheadSet","event","preventDefault","target","tagName","toLowerCase","hours","dataset","metric","activeoptions","getElementsByClassName","i","length","classList","remove","add","setUserPreference","then","fail","exception","Error","tableSearchBehindSet","refreshAction","element","closest","id","refreshElement","actionButton","textContent","innerHTML","period","init","context","tableSearchInputElement","tableSearchResetElement","tableSearchRowsElement","tableSearchAheadElement","tableSearchBehindElement","addEventListener","tableSearch","tableSearchReset","tableSearchRowSet","when","getUserPreference","response","preferences","value","done"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript for student search display and processing.\n *\n * @package    local_assessfreq\n * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/notification',\n    'local_assessfreq/override_modal',\n    'local_assessfreq/table_handler',\n    'local_assessfreq/user_preferences',\n    ], function($, Notification, OverrideModal, TableHandler, UserPreference) {\n\n    /**\n     * Module level variables.\n     */\n    var StudentSearch = {};\n    var contextid;\n    var hoursAhead = 4;\n    var hoursBehind = 1;\n    var refreshPeriod = 60;\n    var counterid;\n\n    /**\n     * Function for refreshing the counter.\n     *\n     * @param {boolean} reset the current count process.\n     */\n    const refreshCounter = function(reset = true) {\n        let progressElement = document.getElementById('local-assessfreq-period-progress');\n\n        // Reset the current count process.\n        if (reset === true) {\n            clearInterval(counterid);\n            counterid = null;\n            progressElement.setAttribute('style', 'width: 100%');\n            progressElement.setAttribute('aria-valuenow', 100);\n        }\n\n        // Exit early if there is already a counter running.\n        if (counterid) {\n            return;\n        }\n\n        counterid = setInterval(() => {\n            let progressWidthAria = progressElement.getAttribute('aria-valuenow');\n            const progressStep = 100 / refreshPeriod;\n\n            if ((progressWidthAria - progressStep) > 0) {\n                progressElement.setAttribute('style', 'width: ' + (progressWidthAria - progressStep) + '%');\n                progressElement.setAttribute('aria-valuenow', (progressWidthAria - progressStep));\n            } else {\n                clearInterval(counterid);\n                counterid = null;\n                progressElement.setAttribute('style', 'width: 100%');\n                progressElement.setAttribute('aria-valuenow', 100);\n                TableHandler.getTable(0, [hoursAhead, hoursBehind], null);\n                refreshCounter();\n            }\n        }, (1000));\n    };\n\n    /**\n     * Process the hours ahead event from the student table.\n     *\n     * @param {Event} event The triggered event for the element.\n     */\n    const tableSearchAheadSet = function(event) {\n        event.preventDefault();\n        if (event.target.tagName.toLowerCase() === 'a') {\n            let hours = event.target.dataset.metric;\n            let activeoptions = document.getElementById('local-assessfreq-quiz-student-table-hoursahead')\n            .getElementsByClassName('active');\n\n            // Fix active classes.\n            for (var i = 0; i < activeoptions.length; i++) {\n                activeoptions[i].classList.remove('active');\n            }\n            event.target.classList.add('active');\n\n            UserPreference.setUserPreference('local_assessfreq_student_search_table_hoursahead_preference', hours)\n            .then(() => {\n                hoursAhead = hours;\n                TableHandler.getTable(0, [hoursAhead, hoursBehind], null); // Reload the table. // Reload the table.\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to update user preference: hours ahead'));\n            });\n        }\n    };\n\n    /**\n     * Process the hours behind event from the student table.\n     *\n     * @param {Event} event The triggered event for the element.\n     */\n    const tableSearchBehindSet = function(event) {\n        event.preventDefault();\n        if (event.target.tagName.toLowerCase() === 'a') {\n            let hours = event.target.dataset.metric;\n            let activeoptions = document.getElementById('local-assessfreq-quiz-student-table-hoursbehind')\n            .getElementsByClassName('active');\n\n            // Fix active classes.\n            for (var i = 0; i < activeoptions.length; i++) {\n                activeoptions[i].classList.remove('active');\n            }\n            event.target.classList.add('active');\n\n            UserPreference.setUserPreference('local_assessfreq_student_search_table_hoursbehind_preference', hours)\n            .then(() => {\n                hoursBehind = hours;\n                TableHandler.getTable(0, [hoursAhead, hoursBehind], null); // Reload the table. // Reload the table.\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to update user preference: hours behind'));\n            });\n        }\n    };\n\n    /**\n     * Handle processing of refresh and period button actions.\n     *\n     * @param {Event} event The triggered event for the element.\n     */\n    const refreshAction = function(event) {\n        event.preventDefault();\n        var element = event.target;\n\n        if (element.closest('button') !== null && element.closest('button').id === 'local-assessfreq-refresh-quiz-dashboard') {\n            refreshCounter(true);\n            TableHandler.getTable(0, [hoursAhead, hoursBehind], null);\n        } else if (element.tagName.toLowerCase() === 'a') {\n            let refreshElement = document.getElementById('local-assessfreq-period-container');\n            let actionButton = refreshElement.getElementsByClassName('dropdown-toggle')[0];\n            actionButton.textContent = element.innerHTML;\n\n            let activeoptions = refreshElement.getElementsByClassName('active');\n\n            // Fix active classes.\n            for (var i = 0; i < activeoptions.length; i++) {\n                activeoptions[i].classList.remove('active');\n            }\n            element.classList.add('active');\n\n            refreshPeriod = element.dataset.period;\n            refreshCounter(true);\n            UserPreference.setUserPreference('local_assessfreq_quiz_refresh_preference', refreshPeriod);\n        }\n    };\n\n    /**\n     * Initialise method for student search.\n     *\n     * @param {integer} context The current context id.\n     */\n    StudentSearch.init = function(context) {\n        contextid = context;\n        TableHandler.init(\n            0,\n            contextid,\n            'local-assessfreq-student-search-table',\n            'local-assessfreq-student-search',\n            'get_student_search_table',\n            'local_assessfreq_student_search_table_rows_preference',\n            'local-assessfreq-quiz-student-table-search',\n            'local_assessfreq_student_search_table',\n            'local_assessfreq_set_table_preference',\n            'local-assessfreq-quiz-student-table-rows'\n        );\n\n        // Add required initial event listeners.\n        let tableSearchInputElement = document.getElementById('local-assessfreq-quiz-student-table-search');\n        let tableSearchResetElement = document.getElementById('local-assessfreq-quiz-student-table-search-reset');\n        let tableSearchRowsElement = document.getElementById('local-assessfreq-quiz-student-table-rows');\n        let tableSearchAheadElement = document.getElementById('local-assessfreq-quiz-student-table-hoursahead');\n        let tableSearchBehindElement = document.getElementById('local-assessfreq-quiz-student-table-hoursbehind');\n        let refreshElement = document.getElementById('local-assessfreq-period-container');\n\n        tableSearchInputElement.addEventListener('keyup', TableHandler.tableSearch);\n        tableSearchInputElement.addEventListener('paste', TableHandler.tableSearch);\n        tableSearchResetElement.addEventListener('click', TableHandler.tableSearchReset);\n        tableSearchRowsElement.addEventListener('click', TableHandler.tableSearchRowSet);\n        tableSearchAheadElement.addEventListener('click', tableSearchAheadSet);\n        tableSearchBehindElement.addEventListener('click', tableSearchBehindSet);\n        refreshElement.addEventListener('click', refreshAction);\n\n        $.when(\n            UserPreference.getUserPreference('local_assessfreq_student_search_table_hoursahead_preference')\n            .then((response) => {\n                hoursAhead = response.preferences[0].value ? response.preferences[0].value : 4;\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to get use preference: hoursahead'));\n            }),\n            UserPreference.getUserPreference('local_assessfreq_student_search_table_hoursbehind_preference')\n            .then((response) => {\n                hoursBehind = response.preferences[0].value ? response.preferences[0].value : 1;\n            })\n            .fail(() => {\n                Notification.exception(new Error('Failed to get use preference: hoursahead'));\n            })\n        ).done(function() {\n            TableHandler.getTable(0, [hoursAhead, hoursBehind], null);\n            OverrideModal.init(context, TableHandler.getTable, [hoursAhead, hoursBehind]);\n        });\n    };\n\n    return StudentSearch;\n});\n"],"file":"student_search.min.js"}