/**
 * Javascript for report card display and processing.
 *
 * @package
 * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("assessfreqreport_activity_dashboard/form_modal",["core/str","core/modal_factory","local_assessfreq/modal_large","core/fragment","core/ajax","core/templates"],(function(Str,ModalFactory,ModalLarge,Fragment,Ajax,Templates){let contextid,iscourse,modalObj,FormModal={},resetOptions=[];const spinner='<p class="text-center"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></p>',observerConfig={attributes:!0,childList:!1,subtree:!0};FormModal.init=function(context,course){contextid=context,iscourse=course,createModal(),document.getElementById("local-assessfreq-find-activity").addEventListener("click",displayModalForm)};const createModal=function(){Str.get_string("modal:loading","assessfreqreport_activity_dashboard","","").then((title=>{ModalFactory.create({type:ModalLarge.TYPE,title:title,body:spinner,large:!0}).done((modal=>{modalObj=modal,modalObj.getRoot().on("click","#id_submitbutton",processModalForm),modalObj.getRoot().on("click","#id_cancel",(e=>{e.preventDefault(),modalObj.setBody(spinner),modalObj.hide()}))}))}))},displayModalForm=function(){updateModalBody(),modalObj.show()},updateModalBody=function(){let formdata=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},params={jsonformdata:JSON.stringify(formdata)};getOptionPlaceholders().then((()=>{Str.get_string("modal:searchactivity","assessfreqreport_activity_dashboard","","").then((title=>{modalObj.setTitle(title),Fragment.loadFragment("assessfreqreport_activity_dashboard","search_form",contextid,params).done(((response,js)=>{modalObj.setBody(response),js&&Templates.runTemplateJS(js),iscourse&&updateActivities(document.getElementsByName("coursechoice")[0].value)}));let modalContainer=document.querySelectorAll('[data-region*="modal-container"]')[0];observer.observe(modalContainer,observerConfig)})).catch((()=>!1))}))},updateActivities=function(courseid){Ajax.call([{methodname:"local_assessfreq_get_activities",args:{courseid:courseid}}])[0].done((response=>{let activityArray=JSON.parse(response),selectElement=document.getElementById("id_activity"),selectElementLength=selectElement.options.length;null!==document.getElementById("noactivitywarning")&&document.getElementById("noactivitywarning").remove();for(let j=selectElementLength-1;j>=0;j--)selectElement.options[j]=null;if(activityArray.length>0){for(let k=0;k<activityArray.length;k++){let opt=activityArray[k],el=document.createElement("option");el.textContent=opt.name,el.value=opt.id,selectElement.appendChild(el)}selectElement.removeAttribute("disabled"),null!==document.getElementById("noactivitywarning")&&document.getElementById("noactivitywarning").remove()}else resetOptions.forEach((option=>{selectElement.appendChild(option)})),document.getElementById("id_activity").value=0,selectElement.disabled=!0}))},observer=new MutationObserver((function(mutationsList){for(let i=0;i<mutationsList.length;i++){let element=mutationsList[i].target;if("span"===element.tagName.toLowerCase()&&element.classList.contains("badge")){element.addEventListener("click",updateModalBody),updateActivities(mutationsList[i].target.dataset.value);break}}})),getOptionPlaceholders=function(){return new Promise((resolve=>{Str.get_strings([{key:"modal:selectcourse",component:"assessfreqreport_activity_dashboard"},{key:"modal:loadingactivity",component:"assessfreqreport_activity_dashboard"}]).then((stringReturn=>{for(let i=0;i<stringReturn.length;i++){let el=document.createElement("option");el.textContent=stringReturn[i],el.value=0-i,resetOptions.push(el)}resolve()})).catch((()=>!1))}))},processModalForm=function(e){e.preventDefault();let activityElement=document.getElementById("id_activity"),activityId=activityElement.options[activityElement.selectedIndex].value;if(void 0===document.getElementsByName("coursechoice")[0].value||activityId<1)null===document.getElementById("noactivitywarning")&&Str.get_string("modal:noactivityselected","assessfreqreport_activity_dashboard","","").then((warning=>{let element=document.createElement("div");element.innerHTML=warning,element.id="noactivitywarning",element.classList.add("alert","alert-danger"),modalObj.getBody().prepend(element)})).catch((()=>!1));else{modalObj.hide(),modalObj.setBody(""),observer.disconnect();let params=new URLSearchParams(location.search);params.set("activityid",activityId),window.location.search=params.toString()}};return FormModal}));

//# sourceMappingURL=form_modal.min.js.map